<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Asiapac 1ã€2æœˆå£½æ˜Ÿæ…¶ç”Ÿæœƒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Pacifico&family=Patrick+Hand&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(120deg, #e0c3fc 0%, #8ec5fc 100%);
            overflow-x: hidden;
            color: #2d3748;
            -webkit-user-select: none;
            user-select: none;
        }

        .font-handwriting { font-family: 'Pacifico', cursive; }
        .font-clue { font-family: 'Patrick Hand', cursive; }
        .perspective-1000 { perspective: 1000px; }
        
        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-style: preserve-3d;
            cursor: pointer;
        }

        .flip-card-inner.flipped { transform: rotateY(180deg); }

        /* V6.5.1 é—œéµä¿®æ­£ï¼šå¼·åˆ¶éš±è—ç¿»è½‰å¾Œçš„ä¾¿åˆ©è²¼ï¼Œè§£æ±º Safari/iOS 3D é€è¦– Bug */
        .flip-card-inner.flipped .sticky-note {
            display: none;
        }

        .flip-card-front, .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            border-radius: 1rem;
            box-shadow: 0 10px 25px -5px rgba(31, 38, 135, 0.37);
            overflow: hidden;
        }

        .flip-card-front {
            background-color: rgba(255, 255, 255, 0.95);
            color: black;
            border: 4px solid #fff;
            overflow: hidden; 
        }

        .flip-card-back {
            background: linear-gradient(to top, #accbee 0%, #e7f0fd 100%);
            color: #333;
            transform: rotateY(180deg);
            display: flex;
            flex-direction: column;
            justify-content: center; 
            align-items: center;
            border: 4px solid #a1c4fd;
        }

        .sticky-note {
            position: absolute;
            background-color: #fef08a;
            color: #854d0e;
            padding: 4px 8px;
            font-family: 'Patrick Hand', cursive;
            font-weight: bold;
            font-size: 0.9rem;
            box-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            transform: rotate(-5deg);
            z-index: 20;
            border-bottom-right-radius: 15px 5px;
            max-width: 90%;
            word-wrap: break-word;
            pointer-events: none;
            border: 1px solid #fde047;
        }

        /* çµå†°æ•ˆæœ (Frost) */
        .frost-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 90;
            box-shadow: inset 0 0 150px 50px rgba(255, 255, 255, 0.95);
            opacity: 0;
            transition: opacity 1s ease;
        }

        /* èµ·éœ§æ•ˆæœ (Fog Canvas) */
        #fog-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 95;
            cursor: pointer;
            pointer-events: none;
            opacity: 0;
            transition: opacity 1s ease;
        }
        #fog-canvas.fog-active {
            pointer-events: auto;
            opacity: 1;
        }

        /* AI æ—äº‚åŠ©æ‰‹ */
        #ai-helper {
            position: fixed;
            bottom: 80px;
            right: -300px;
            width: 250px;
            z-index: 110;
            transition: right 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            filter: drop-shadow(-5px 5px 10px rgba(0,0,0,0.2));
        }
        #ai-helper.show {
            right: 20px;
        }
        .speech-bubble {
            position: relative;
            background: #fff;
            border-radius: 15px;
            padding: 10px 15px;
            margin-bottom: 10px;
            font-size: 0.9rem;
            color: #333;
            font-weight: bold;
            border: 2px solid #cbd5e1;
        }
        .speech-bubble::after {
            content: '';
            position: absolute;
            bottom: -10px;
            right: 40px;
            border-width: 10px 10px 0;
            border-style: solid;
            border-color: #cbd5e1 transparent;
            display: block;
            width: 0;
        }

        .floating-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            overflow: hidden;
        }
        .floating-item {
            position: absolute;
            color: rgba(255, 255, 255, 0.6);
            animation: floatDown 15s linear infinite;
        }
        @keyframes floatDown {
            0% { transform: translateY(-10vh) rotate(0deg) translateX(0); opacity: 0; }
            10% { opacity: 0.8; }
            100% { transform: translateY(110vh) rotate(360deg) translateX(20px); opacity: 0; }
        }

        .wood-tag {
            background-color: #e6c9a8;
            background-image: repeating-linear-gradient(45deg, rgba(255,255,255,0.3) 0px, transparent 1px, transparent 10px);
            border: 2px solid #d4a77a;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .shake-animation { animation: shake 0.3s ease-in-out; }
    </style>
</head>
<body class="min-h-screen pt-10 pb-16 md:py-10 px-4">

    <!-- èƒŒæ™¯æ¼‚æµ®è£é£¾ -->
    <div class="floating-bg">
        <i class="fas fa-snowflake text-4xl floating-item" style="left: 10%; animation-duration: 12s; animation-delay: 0s;"></i>
        <i class="fas fa-snowflake text-2xl floating-item" style="left: 25%; animation-duration: 18s; animation-delay: 5s;"></i>
        <i class="fas fa-star text-3xl floating-item" style="left: 40%; animation-duration: 15s; animation-delay: 2s;"></i>
        <i class="fas fa-snowflake text-5xl floating-item" style="left: 60%; animation-duration: 20s; animation-delay: 7s;"></i>
        <i class="fas fa-snowflake text-3xl floating-item" style="left: 80%; animation-duration: 14s; animation-delay: 1s;"></i>
        <i class="fas fa-star text-2xl floating-item" style="left: 90%; animation-duration: 22s; animation-delay: 10s;"></i>
    </div>

    <!-- çµå†°æ•ˆæœå±¤ -->
    <div id="frost-overlay" class="frost-overlay"></div>
    <!-- èµ·éœ§ç•«å¸ƒ (ç”¨æ–¼æ“¦æ‹­) -->
    <canvas id="fog-canvas"></canvas>

    <!-- AI æ—äº‚åŠ©æ‰‹ -->
    <div id="ai-helper">
        <div class="speech-bubble" id="helper-msg">å—¨ï¼æˆ‘æ˜¯ä½ çš„æ—äº‚å°å¹«æ‰‹ ğŸ§</div>
        <div class="text-6xl text-right pr-4 transform hover:scale-110 transition cursor-pointer">ğŸ§</div>
    </div>

    <!-- å·¦ä¸Šè§’å³æ™‚ç¨±è™Ÿå¾½ç«  -->
    <div id="player-title-badge" class="fixed top-4 left-4 z-40 bg-white/80 backdrop-blur-md px-4 py-2 rounded-full shadow-lg border-2 border-sky-200 flex items-center gap-3 transition-all duration-300 hover:scale-105 hover:shadow-xl cursor-default">
        <span id="current-title-icon" class="text-2xl">ğŸŒ±</span>
        <div class="flex flex-col leading-tight">
           <span class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">Current Rank</span>
           <span id="current-title-text" class="text-sm md:text-base font-bold text-sky-700">æ–°æ‰‹æ‘æ‘æ°‘</span>
        </div>
    </div>

    <!-- æ¨™é¡Œå€ -->
    <header class="text-center relative z-10 mt-12 mb-4 md:mt-0 md:mb-16">
        <div class="inline-block bg-white/60 backdrop-blur-md px-10 py-8 rounded-3xl shadow-lg border border-white/80">
            <h1 class="text-4xl md:text-6xl font-bold text-gray-800 mb-10 drop-shadow-sm font-handwriting text-blue-500">
                Happy Birthday!
            </h1>
            <h2 class="text-xl md:text-2xl font-bold text-slate-600">
                <span class="text-sky-500"><i class="fas fa-search"></i></span> 
                çŒœçŒœé€™æ¬¡å£½æ˜Ÿæ˜¯èª°ï¼Ÿ 
                <span class="text-purple-400"><i class="fas fa-smile-wink"></i></span>
            </h2>
        </div>
        <p class="text-white font-bold text-lg mt-4 drop-shadow-md tracking-wider">â„ï¸ åœ¨å¯’å†·çš„å­£ç¯€ï¼Œé€ä¸Šæœ€æº«æš–çš„ç¥ç¦ â„ï¸</p>
    </header>

    <!-- éŠæˆ²å¡ç‰‡å®¹å™¨ -->
    <div id="game-container" class="relative z-10 max-w-7xl mx-auto grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8 pb-20">
        <!-- å¡ç‰‡å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
    </div>

    <!-- åº•éƒ¨æ§åˆ¶å€ -->
    <div class="fixed bottom-0 left-0 w-full bg-white/80 backdrop-blur-md p-4 shadow-[0_-5px_15px_rgba(0,0,0,0.1)] z-50 flex flex-wrap justify-center items-center gap-3 border-t border-white/50">
        <button onclick="clearData()" class="bg-red-100 hover:bg-red-200 text-red-600 font-bold py-2 px-4 rounded-full transition duration-300 text-sm border border-red-200" title="æ¸…é™¤æ‰€æœ‰çŒœé¡Œç´€éŒ„">
            <i class="fas fa-trash-alt mr-1"></i> é‡ç½®ç´€éŒ„
        </button>
        
        <button onclick="resetAllCards()" class="bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold py-2 px-4 rounded-full transition duration-300 text-sm border border-slate-300">
            <i class="fas fa-redo-alt mr-1"></i> å…¨éƒ¨è“‹ç‰Œ
        </button>

        <button onclick="shareScore()" class="bg-green-100 hover:bg-green-200 text-green-700 font-bold py-2 px-4 rounded-full transition duration-300 text-sm border border-green-200">
            <i class="fas fa-share-alt mr-1"></i> è¤‡è£½æˆ°ç¸¾
        </button>

        <button onclick="celebrateNow()" class="bg-gradient-to-r from-sky-400 to-indigo-500 hover:from-sky-500 hover:to-indigo-600 text-white font-bold py-2 px-6 rounded-full shadow-lg transform hover:scale-105 transition duration-300 ring-2 ring-offset-2 ring-sky-200">
            <i class="fas fa-glass-cheers mr-2"></i> ä¸€èµ·æ…¶ç¥ï¼
        </button>
    </div>

    <!-- çŒœè¬äº’å‹•è¦–çª— (Modal) -->
    <div id="guess-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] hidden flex justify-center items-center px-4">
        <div class="bg-white rounded-2xl p-6 md:p-8 max-w-sm w-full shadow-2xl border-4 border-sky-200 relative transform transition-all scale-100">
            <div class="absolute -top-6 left-1/2 transform -translate-x-1/2 bg-sky-500 text-white w-12 h-12 rounded-full flex items-center justify-center shadow-lg border-2 border-white text-xl">
                <i class="fas fa-question"></i>
            </div>
            
            <h3 class="text-2xl font-bold text-slate-700 mt-4 mb-2 text-center">ä½ çŸ¥é“æˆ‘æ˜¯èª°å—ï¼Ÿ</h3>
            <p class="text-slate-500 text-sm text-center mb-6">è«‹è¼¸å…¥è‹±æ–‡åå­—çŒœçŒœçœ‹ï¼</p>
            
            <div class="mb-6 relative">
                <input type="text" id="guess-input" placeholder="Ex: John" 
                       class="w-full border-2 border-slate-300 rounded-xl py-3 px-4 text-center text-xl font-bold text-slate-700 focus:outline-none focus:border-sky-400 focus:ring-4 focus:ring-sky-100 transition-all placeholder-slate-300"
                       autocomplete="off">
                <p id="error-msg" class="text-red-500 text-sm font-bold text-center mt-2 hidden animate-pulse">
                    <i class="fas fa-times-circle mr-1"></i> çŒœéŒ¯å›‰ï¼å†è©¦è©¦çœ‹ï¼Ÿ
                </p>
            </div>
            
            <div class="flex gap-3 justify-center">
                <button onclick="giveUp()" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-600 font-bold py-3 px-4 rounded-xl transition duration-200 text-sm">
                    å¿ç—›æ”¾æ£„
                </button>
                <button onclick="checkAnswer()" class="flex-1 bg-gradient-to-r from-sky-400 to-indigo-500 hover:from-sky-500 hover:to-indigo-600 text-white font-bold py-3 px-4 rounded-xl shadow-md transition duration-200 transform active:scale-95 text-sm">
                    <i class="fas fa-check mr-1"></i> ç¢ºå®š
                </button>
            </div>

            <button onclick="closeModal()" class="absolute top-4 right-4 text-slate-300 hover:text-slate-500 transition">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
    </div>

    <script>
        // ==========================================
        // è³‡æ–™è¨­å®šå€
        // ==========================================
        const birthdayStars = [
            { id: 1, clueImage: "./images/whoami01.jpg", clueText: "æç¤ºï¼š\nè’™å¨œniè", realImage: "./images/who01.jpg", name: "Nick Lin", department: "AMæ•¸ä½å»£å‘Šéƒ¨é–€", message: "ç¥å¦³å‰µæ„ç„¡é™ï¼Œå¤©å¤©é–‹å¿ƒï¼âœ¨", constellation: "â™’", birthDate: "02/05" },
            { id: 2, clueImage: "./images/whoami02.jpg", clueText: "æç¤ºï¼š\né€™æ˜¯èª°äº‚äº‚çš„æ¡Œé¢ï¼Ÿ", realImage: "./images/who02.jpg", name: "Ken Lee", department: "AMæ•¸ä½å»£å‘Šéƒ¨é–€", message: "Bug é€€æ•£ï¼Œæº–æ™‚ä¸‹ç­ï¼ğŸš€", constellation: "â™‘", birthDate: "01/15" },
            { id: 3, clueImage: "./images/whoami03.jpg", clueText: "æç¤ºï¼š\nå¤©ä½¿çœ¼çœ¸ï¼Ÿé­”é¬¼èº«æï¼Ÿ", realImage: "./images/who03.jpg", name: "Amber Tsai", department: "BSå¸‚å ´ç‡Ÿé‹éƒ¨é–€", message: "è¬è¬å¦³ç¸½æ˜¯ç…§é¡§å¤§å®¶ï¼ğŸ‚", constellation: "â™‘", birthDate: "01/14" },
            { id: 4, clueImage: "./images/whoami04.jpg", clueText: "æç¤ºï¼š\nèª°é¤Šäº†å…©éš»å°æ©˜è²“", realImage: "./images/who04.jpg", name: "Kavass Chang", department: "SMç¤¾ç¾¤åª’é«”éƒ¨é–€", message: "æ¥­ç¸¾é•·ç´…ï¼Œè¨‚å–®æ¥ä¸å®Œï¼ğŸ’°", constellation: "â™’", birthDate: "01/22" },
            { id: 5, clueImage: "./images/whoami05.jpg", clueText: "æç¤ºï¼š\né›–ç„¶ä¸åœ¨ä»™å¢ƒå·¥ä½œ<br>ä½†åå­—è‡ªå¸¶å¥‡å¹»é­”æ³•", realImage: "./images/who05.jpg", name: "Alice Shih", department: "HRäººåŠ›è³‡æºéƒ¨é–€", message: "é¡˜å¦³çš„ç”Ÿæ´»å¦‚è¨­è¨ˆèˆ¬ç²¾å½©ï¼ğŸ¨", constellation: "â™‘", birthDate: "01/15" },
            { id: 6, clueImage: "./images/whoami06.jpg", clueText: "æç¤ºï¼š\næ˜¯èª°å°æ™‚å€™ç¶é›™é¦¬å°¾å°±é€™éº¼ç„¡æ•µï¼", realImage: "./images/who06.jpg", name: "Harper Huang", department: "SMå°ä¸­ç¤¾ç¾¤åª’é«”éƒ¨é–€", message: "å¤©å¤©é›ç‹—ï¼Œå¤©å¤©é–‹å¿ƒï¼ğŸ¶", constellation: "â™‘", birthDate: "01/17" },
            { id: 7, clueImage: "./images/whoami07.jpg", clueText: "æç¤ºï¼š\nèˆ‡ç†Šå¤§ã€å…”å…”å½¢å½±ä¸é›¢", realImage: "./images/who07.jpg", name: "Sally Seo", department: "HRäººåŠ›è³‡æºéƒ¨é–€", message: "ç¥å¦³è²¡æºæ»¾æ»¾ä¾†ï¼â˜•", constellation: "â™“", birthDate: "02/21" },
            { id: 8, clueImage: "./images/whoami08.jpg", clueText: "æç¤ºï¼š\nç„¡æ„é–“ç™¼ç¾Dcardä¸Šçš„ç…§ç‰‡å±…ç„¶æ˜¯æˆ‘åŒäº‹ï¼", realImage: "./images/who08.jpg", name: "Mollie Chen", department: "SMå°ä¸­ç¤¾ç¾¤åª’é«”éƒ¨é–€", message: "æ°¸é ä¿æŒå†’éšªçš„ç²¾ç¥ï¼â›°ï¸", constellation: "â™‘", birthDate: "01/11" },
            { id: 9, clueImage: "./images/whoami09.jpg", clueText: "æç¤ºï¼š\nå¥èº«æˆ¿æ˜¯ç¬¬äºŒå€‹å®¶", realImage: "./images/who09.jpg", name: "Tris Chu", department: "AMå°ä¸­æ•¸ä½å»£å‘Šéƒ¨é–€", message: "å¥åº·ç¾éº—ï¼Œæ´»åŠ›æ»¿æ»¿ï¼ğŸ’ª", constellation: "â™’", birthDate: "02/16" },
            { id: 10, clueImage: "./images/whoami10.jpg", clueText: "æç¤ºï¼š\nè¾¦å…¬å®¤çš„æ–æ»¾å·¨æ˜Ÿ", realImage: "./images/who10.jpg", name: "Akane Lin", department: "SMç¤¾ç¾¤åª’é«”éƒ¨é–€", message: "Rock n' Roll Forever! ğŸ¸", constellation: "â™‘", birthDate: "01/18" },
            { id: 11, clueImage: "./images/whoami11.jpg", clueText: "æç¤ºï¼š\né€™æ˜¯å“ªä½å£½æ˜Ÿçš„åº§ä½ï¼Ÿ", realImage: "./images/who11.jpg", name: "Scott Chang", department: "BSå°ä¸­å¸‚å ´ç‡Ÿé‹éƒ¨é–€", message: "ç­‰ç´šç„¡é™å‡ï¼Œè£å‚™å…¨ç¥è£ï¼ğŸ®", constellation: "â™’", birthDate: "02/06" },
        ];

        // ==========================================
        // ç¨‹å¼é‚è¼¯å€
        // ==========================================
        const container = document.getElementById('game-container');
        const modal = document.getElementById('guess-modal');
        const guessInput = document.getElementById('guess-input');
        const errorMsg = document.getElementById('error-msg');
        
        const titleIcon = document.getElementById('current-title-icon');
        const titleText = document.getElementById('current-title-text');
        const titleBadge = document.getElementById('player-title-badge');

        const aiHelper = document.getElementById('ai-helper');
        const helperMsg = document.getElementById('helper-msg');
        const frostOverlay = document.getElementById('frost-overlay');
        const fogCanvas = document.getElementById('fog-canvas');

        let currentCardElement = null;
        let currentCorrectAnswer = "";
        let currentStarId = null;

        let globalConsecutiveWrong = 0;

        const errorMessages = [
            "ç…§è‘—æç¤ºæƒ³çœ‹çœ‹ï¼ŒåŠ æ²¹ï¼",
            "æ¯ä¸Ÿå“¦ï¼å†è©¦è©¦çœ‹ï¼Ÿ",
            "ä½ æ˜¯ä¸æ˜¯è·ŸåŒäº‹å¾ˆä¸ç†Ÿï¼Ÿ"
        ];
        let errorMsgIndex = 0;

        const STORAGE_KEY = 'birthdayGame_stats_v2';

        const annoyingPhrases = [
            "éœ€è¦å¹«å¿™å—ï¼Ÿä½†æˆ‘ä¹Ÿä¸èªè­˜ä»– ğŸ§",
            "ä½ æ˜¯ä¸æ˜¯åªèªè­˜éš”å£éƒ¨é–€çš„ï¼Ÿ",
            "é€™éº¼æ˜é¡¯é‚„çŒœéŒ¯ï¼Œæˆ‘ä¹Ÿå¹«ä¸äº†ä½ ",
            "è¦ä¸è¦è€ƒæ…®å»æ‹¿é€šè¨ŠéŒ„ä¾†çœ‹ï¼Ÿ",
            "ä¾¿åˆ©è²¼è¶Šä¾†è¶Šå¤šäº†å–”...",
            "å†éŒ¯ä¸‹å»è¢å¹•è¦çµå†°å›‰ â„ï¸",
            "åŠ æ²¹å¥½å—ï¼Ÿ",
            "æˆ‘è¦ºå¾—è¢å¹•å¥½åƒè®Šå†·äº†..."
        ];

        function getStats(id) {
            const allStats = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
            return allStats[id] || { wins: 0, losses: 0, wrongNames: [] };
        }

        function updateStats(id, isWin, wrongName = null) {
            const allStats = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
            if (!allStats[id]) {
                allStats[id] = { wins: 0, losses: 0, wrongNames: [] };
            }
            if (isWin) {
                allStats[id].wins += 1;
            } else {
                allStats[id].losses += 1;
            }
            if (wrongName && !allStats[id].wrongNames.includes(wrongName)) {
                allStats[id].wrongNames.push(wrongName);
            }

            localStorage.setItem(STORAGE_KEY, JSON.stringify(allStats));
            return allStats[id];
        }

        function clearData() {
            if (confirm("ç¢ºå®šè¦é‡ç½®æ‰€æœ‰ç´€éŒ„å—ï¼Ÿ(ä¾¿åˆ©è²¼èˆ‡æˆ°ç¸¾å°‡æ­¸é›¶)")) {
                localStorage.removeItem(STORAGE_KEY);
                alert("ç´€éŒ„å·²é‡ç½®ï¼é é¢å°‡é‡æ–°æ•´ç†ã€‚");
                location.reload();
            }
        }

        // V6.5.0: ç´°åŒ–ç¨±è™Ÿç´šè·
        function calculateTitle(wins) {
             const totalStars = birthdayStars.length;
             const completionRate = wins / totalStars;

             if (wins === 0) return { text: "æ–°æ‰‹æ‘æ‘æ°‘", icon: "ğŸŒ±" };
             if (completionRate === 1) return { text: "Asiapac äººé¡å­¸å®¶", icon: "ğŸ‘‘" };
             if (completionRate >= 0.8) return { text: "ç¤¾äº¤é”äºº", icon: "ğŸ†" };
             if (completionRate >= 0.6) return { text: "è·å ´è§€å¯Ÿå“¡", icon: "ğŸ”" };
             if (completionRate >= 0.4) return { text: "èŒ¶æ°´é–“å¸¸å®¢", icon: "â˜•" };
             if (completionRate >= 0.2) return { text: "æœ€ç†Ÿæ‚‰çš„é™Œç”Ÿäºº", icon: "ğŸ¤”" };
             
             return { text: "åŠªåŠ›èªè­˜å¤§å®¶ä¸­", icon: "ğŸ’ª" };
        }

        function updateTitleDisplay() {
            const allStats = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
            let totalWins = 0;
            
            birthdayStars.forEach(star => {
                const stat = allStats[star.id];
                if (stat && stat.wins > 0) {
                    totalWins++;
                }
            });
            const titleData = calculateTitle(totalWins);
            titleIcon.textContent = titleData.icon;
            titleText.textContent = titleData.text;
            titleBadge.classList.add('scale-110');
            setTimeout(() => titleBadge.classList.remove('scale-110'), 200);
        }

        function showHelper(text) {
            helperMsg.innerText = text;
            aiHelper.classList.add('show');
            setTimeout(() => {
                aiHelper.classList.remove('show');
            }, 3500);
        }

        function updateWeatherEffects() {
            if (globalConsecutiveWrong > 0 && globalConsecutiveWrong < 10) {
                let opacity = Math.min(globalConsecutiveWrong * 0.1, 0.9);
                frostOverlay.style.opacity = opacity;
                
                if (fogCanvas.classList.contains('fog-active')) {
                     fogCanvas.classList.remove('fog-active');
                }
            } else if (globalConsecutiveWrong >= 10) {
                frostOverlay.style.opacity = 1;
                if (!fogCanvas.classList.contains('fog-active')) {
                    fogCanvas.classList.add('fog-active');
                    initFog(); 
                }
            } else {
                frostOverlay.style.opacity = 0;
                fogCanvas.classList.remove('fog-active');
            }
        }

        function initFog() {
            const ctx = fogCanvas.getContext('2d');
            fogCanvas.width = window.innerWidth;
            fogCanvas.height = window.innerHeight;
            
            ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
            ctx.fillRect(0, 0, fogCanvas.width, fogCanvas.height);
            
            ctx.fillStyle = '#64748b';
            ctx.font = 'bold 30px Noto Sans TC';
            ctx.textAlign = 'center';
            ctx.fillText("å¥½å†·å•Š... è¢å¹•çµå†°äº†ï¼", fogCanvas.width/2, fogCanvas.height/2 - 20);
            ctx.font = '20px Noto Sans TC';
            ctx.fillText("(å¿«ç”¨åŠ›æŠŠå†°éœœæ“¦æ‰)", fogCanvas.width/2, fogCanvas.height/2 + 20);

            let isDrawing = false;
            
            function wipe(x, y) {
                ctx.globalCompositeOperation = 'destination-out';
                ctx.beginPath();
                ctx.arc(x, y, 100, 0, Math.PI * 2); 
                ctx.fill();
            }

            function checkClear() {
                const w = fogCanvas.width;
                const h = fogCanvas.height;
                const imageData = ctx.getImageData(0, 0, w, h);
                const data = imageData.data;
                const sampleRate = 100; 
                
                let clearedCount = 0;
                let totalChecked = 0;

                for (let i = 3; i < data.length; i += 4 * sampleRate) {
                    totalChecked++;
                    if (data[i] < 128) { 
                        clearedCount++;
                    }
                }

                if (totalChecked > 0 && (clearedCount / totalChecked) > 0.5) {
                    fogCanvas.classList.remove('fog-active');
                    showHelper("å‘¼ï½çµ‚æ–¼çœ‹æ¸…æ¥šäº†ï¼(ç›®å‰çµå†°ç­‰ç´š: 3) ğŸ§");
                    
                    globalConsecutiveWrong = 3;
                    updateWeatherEffects();
                }
            }

            fogCanvas.addEventListener('mousedown', () => isDrawing = true);
            fogCanvas.addEventListener('mouseup', () => {
                isDrawing = false;
                checkClear(); 
            });
            fogCanvas.addEventListener('mousemove', (e) => {
                if (isDrawing || e.buttons === 1) { 
                    wipe(e.clientX, e.clientY);
                }
            });
            
            fogCanvas.addEventListener('touchstart', () => isDrawing = true);
            fogCanvas.addEventListener('touchend', () => {
                isDrawing = false;
                checkClear();
            });
            fogCanvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                wipe(touch.clientX, touch.clientY);
            });
        }
        
        window.addEventListener('resize', () => {
            if (fogCanvas.classList.contains('fog-active')) {
                initFog();
            }
        });


        function shareScore() {
            const allStats = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
            let totalWins = 0;
            // V6.4.6: ç§»é™¤ totalAttempted
            birthdayStars.forEach(star => {
                const stat = allStats[star.id];
                if (stat && stat.wins > 0) {
                    totalWins++;
                }
            });
            const titleData = calculateTitle(totalWins);
            const shareText = `ã€Asiapac å£½æ˜ŸçŒœè¬æŒ‘æˆ°ã€‘\næˆ‘çŒœå‡ºäº† ${totalWins} / ${birthdayStars.length} ä½å£½æ˜Ÿï¼\nç²å¾—ç¨±è™Ÿï¼š${titleData.text} ${titleData.icon}\nå¿«ä¾†æŒ‘æˆ°çœ‹çœ‹ä½ èªå¾—å¹¾ä½åŒäº‹ï¼â„ï¸ğŸ‚`;
            
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(shareText).then(() => {
                    alert("æˆ°ç¸¾å·²è¤‡è£½ï¼å¿«å»ç¾¤çµ„è²¼ä¸Šå§ï¼ğŸ“‹");
                }).catch(() => fallbackCopyTextToClipboard(shareText));
            } else {
                fallbackCopyTextToClipboard(shareText);
            }
        }

        function fallbackCopyTextToClipboard(text) {
            var textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";  
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                var successful = document.execCommand('copy');
                alert("æˆ°ç¸¾å·²è¤‡è£½ï¼å¿«å»ç¾¤çµ„è²¼ä¸Šå§ï¼ğŸ“‹");
            } catch (err) {
                alert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•æˆªåœ–åˆ†äº« ğŸ˜­");
            }
            document.body.removeChild(textArea);
        }

        function generateStickyNotesHTML(wrongNames) {
            if (!wrongNames || wrongNames.length === 0) return '';
            
            return wrongNames.map((name, index) => {
                const top = 10 + (Math.random() * 60); 
                const left = 5 + (Math.random() * 60); 
                const rotate = -10 + (Math.random() * 20); 
                const color = index % 2 === 0 ? '#fef08a' : '#fbcfe8'; 
                const style = `top: ${top}%; left: ${left}%; transform: rotate(${rotate}deg); background-color: ${color};`;
                
                return `<div class="sticky-note" style="${style}">Not ${name}!</div>`;
            }).join('');
        }

        function renderCards() {
            container.innerHTML = '';
            birthdayStars.forEach(star => {
                const cardWrapper = document.createElement('div');
                cardWrapper.className = 'bg-transparent h-96 w-full perspective-1000 group';

                const cardInner = document.createElement('div');
                cardInner.className = 'flip-card-inner relative w-full h-full shadow-xl rounded-xl transition-all duration-500';
                
                cardInner.setAttribute('data-answer', star.name);
                cardInner.setAttribute('data-id', star.id);
                cardInner.onclick = function() { handleCardClick(this); };

                const stats = getStats(star.id);
                const stickyNotesHTML = generateStickyNotesHTML(stats.wrongNames);

                const cardFront = document.createElement('div');
                cardFront.className = 'flip-card-front flex flex-col items-center bg-white';
                cardFront.innerHTML = `
                    <div class="h-3/4 w-full p-3 pb-0 relative">
                        <div class="w-full h-full overflow-hidden rounded-t-lg bg-slate-50 relative border border-slate-100">
                            <img src="${star.clueImage}" alt="Clue" class="w-full h-full object-cover transition duration-300 group-hover:scale-110 group-hover:rotate-1">
                            <div class="absolute top-2 right-2 bg-sky-400 text-white text-xs font-bold px-2 py-1 rounded-full shadow-md">
                                <i class="fas fa-search"></i> Clue
                            </div>
                        </div>
                        ${stickyNotesHTML}
                    </div>
                    <div class="h-1/4 w-full flex flex-col justify-center items-center p-2 bg-white">
                        <p class="font-bold text-slate-600 text-lg text-center whitespace-pre-line font-clue transform -rotate-2">${star.clueText}</p>
                    </div>
                `;

                const cardBack = document.createElement('div');
                cardBack.className = 'flip-card-back p-4 relative'; 
                cardBack.innerHTML = `
                    <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-sky-300 via-blue-400 to-indigo-400"></div>
                    
                    <div class="wood-tag absolute top-3.5 right-3 px-3 py-1 rounded-md transform rotate-3 flex items-center gap-1 z-10">
                        <span class="text-xl leading-none text-amber-800" title="æ˜Ÿåº§">${star.constellation || 'â˜…'}</span>
                        <span class="text-sm font-bold font-mono text-amber-900 tracking-tighter">${star.birthDate || '??/??'}</span>
                    </div>

                    <div class="w-28 h-28 rounded-full overflow-hidden border-4 border-white shadow-lg mb-3 ring-2 ring-sky-200 mt-2">
                        <img src="${star.realImage}" alt="${star.name}" id="img-${star.id}" class="w-full h-full object-cover">
                    </div>
                    <h2 class="text-2xl font-bold text-slate-800 mb-0">${star.name}</h2>
                    <span class="text-slate-500 text-sm mb-2">${star.department}</span>
                    
                    <div class="bg-white/70 p-3 rounded-lg w-full text-center shadow-sm backdrop-blur-sm">
                        <p class="text-slate-700 italic text-sm font-medium">"${star.message}"</p>
                    </div>
                    
                    <div class="mt-3 flex gap-2">
                        <span class="text-sky-500 text-lg animate-bounce"><i class="fas fa-snowflake"></i></span>
                        <span class="text-indigo-500 text-lg animate-bounce" style="animation-delay: 0.1s"><i class="fas fa-gift"></i></span>
                        <span class="text-purple-500 text-lg animate-bounce" style="animation-delay: 0.2s"><i class="fas fa-glass-cheers"></i></span>
                    </div>
                `;

                cardInner.appendChild(cardFront);
                cardInner.appendChild(cardBack);
                cardWrapper.appendChild(cardInner);
                container.appendChild(cardWrapper);
            });
        }

        function handleCardClick(element) {
            if (element.classList.contains('flipped')) {
                element.classList.remove('flipped');
                return;
            }
            currentCardElement = element;
            currentCorrectAnswer = element.getAttribute('data-answer');
            currentStarId = element.getAttribute('data-id'); 
            openGuessModal();
        }

        function openGuessModal() {
            modal.classList.remove('hidden');
            guessInput.value = ''; 
            guessInput.focus();    
            errorMsg.classList.add('hidden'); 
        }

        function closeModal() {
            modal.classList.add('hidden');
            currentCardElement = null;
            currentStarId = null; 
        }

        function refreshCardStatsDisplay(id, newStats) {
            if (newStats.wrongNames.length > 0) {
                const cardFrontContainer = currentCardElement.querySelector('.flip-card-front .relative');
                const lastWrongName = newStats.wrongNames[newStats.wrongNames.length - 1];
                
                const top = 10 + (Math.random() * 60); 
                const left = 5 + (Math.random() * 60); 
                const rotate = -10 + (Math.random() * 20); 
                const color = newStats.wrongNames.length % 2 === 0 ? '#fef08a' : '#fbcfe8';
                
                const note = document.createElement('div');
                note.className = 'sticky-note';
                note.style.cssText = `top: ${top}%; left: ${left}%; transform: rotate(${rotate}deg); background-color: ${color};`;
                note.innerText = `Not ${lastWrongName}!`;
                
                cardFrontContainer.appendChild(note);
            }

            updateTitleDisplay();
        }

        function checkAnswer() {
            const userGuess = guessInput.value.trim().toLowerCase();
            const correctName = currentCorrectAnswer.toLowerCase();

            if (userGuess && correctName.includes(userGuess)) {
                if (currentStarId) {
                    const newStats = updateStats(currentStarId, true);
                    refreshCardStatsDisplay(currentStarId, newStats);
                }

                globalConsecutiveWrong = 0;
                updateWeatherEffects();

                flipCurrentCard(); 
                closeModal();      
                errorMsgIndex = 0; 
            } else {
                const msg = errorMessages[errorMsgIndex % errorMessages.length];
                errorMsg.innerHTML = `<i class="fas fa-times-circle mr-1"></i> ${msg}`;
                errorMsgIndex++; 
                
                if (userGuess && currentStarId) {
                    const newStats = updateStats(currentStarId, false, guessInput.value.trim()); 
                    refreshCardStatsDisplay(currentStarId, newStats);
                } else if (currentStarId) {
                    updateStats(currentStarId, false);
                }

                globalConsecutiveWrong++;
                updateWeatherEffects();

                const randomPhrase = annoyingPhrases[Math.floor(Math.random() * annoyingPhrases.length)];
                showHelper(randomPhrase);

                errorMsg.classList.remove('hidden');
                const inputContainer = document.querySelector('#guess-modal input');
                inputContainer.classList.add('shake-animation');
                setTimeout(() => inputContainer.classList.remove('shake-animation'), 300);
                guessInput.value = ''; 
                guessInput.focus();
            }
        }

        // V6.4.5: ä¿®æ­£ giveUp é‚è¼¯ï¼Œé¿å…é‡è¤‡ç”¢ç”Ÿä¾¿åˆ©è²¼
        function giveUp() {
            if (currentStarId) {
                // æ›´æ–°çµ±è¨ˆ (å¢åŠ æ”¾æ£„æ¬¡æ•¸)
                updateStats(currentStarId, false);
                // V6.4.5: åªæ›´æ–°ç¨±è™Ÿï¼Œä¸å‘¼å« refreshCardStatsDisplay ä»¥é¿å…é‡è¤‡è²¼ä¾¿åˆ©è²¼
                updateTitleDisplay();
            }

            globalConsecutiveWrong++;
            updateWeatherEffects();
            showHelper("æ”¾æ£„æ˜¯ç‚ºäº†èµ°æ›´é•·é çš„è·¯...å—ï¼ŸğŸ§");

            flipCurrentCard(); 
            closeModal();      
        }

        function flipCurrentCard() {
            if (currentCardElement) {
                currentCardElement.classList.add('flipped');
                try {
                    playConfetti(0.5); 
                } catch(e) {
                    console.log('Confetti failed but card flipped');
                }
            }
        }

        guessInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                checkAnswer();
            }
        });

        function resetAllCards() {
            const cards = document.querySelectorAll('.flip-card-inner');
            cards.forEach(card => card.classList.remove('flipped'));
        }

        function celebrateNow() {
            var duration = 2000;
            var end = Date.now() + duration;

            (function frame() {
                confetti({
                    particleCount: 3,
                    angle: 60,
                    spread: 55,
                    origin: { x: 0 },
                    colors: ['#a1c4fd', '#c2e9fb', '#ffffff', '#e0c3fc']
                });
                confetti({
                    particleCount: 3,
                    angle: 120,
                    spread: 55,
                    origin: { x: 1 },
                    colors: ['#a1c4fd', '#c2e9fb', '#ffffff', '#e0c3fc']
                });

                if (Date.now() < end) {
                    requestAnimationFrame(frame);
                }
            }());
        }

        function playConfetti(seconds) {
             confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 },
                colors: ['#a1c4fd', '#c2e9fb', '#ffffff']
            });
        }

        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
        });

        renderCards();

        window.addEventListener('load', () => {
            updateTitleDisplay(); 
            setTimeout(() => {
               playConfetti(1);
            }, 500);
        });

    </script>
</body>
</html>